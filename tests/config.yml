---

- name: Config
  hosts: all
  vars:
    manala_fail2ban_config:
      - DEFAULT:
        - maxretry: 5
      - ssh:
        - enabled: false
  roles:
    - manala.fail2ban
  post_tasks:
    # Goss
    - name: Goss
      raw: "{{ 'echo \"' ~ item|to_yaml ~ '\"|goss -g - validate' }}"
      with_items:
        - package:
            fail2ban:
              installed: true
        - process:
            fail2ban-server:
              running: true
        - file:
            /etc/fail2ban/jail.local:
              exists: true
              contains:
                - "[DEFAULT]"
                - "maxretry = 5"
                - "[ssh]"
                - "enabled = false"
